<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug User Role</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: monospace;
            max-width: 1000px;
            margin: 20px auto;
            padding: 20px;
            background: #1a1a1a;
            color: #00ff00;
        }
        .container {
            background: #2a2a2a;
            padding: 30px;
            border-radius: 8px;
            border: 1px solid #00ff00;
        }
        h1 { color: #00ff00; text-align: center; }
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-left: 4px solid #00ff00;
            background: #333;
        }
        .error { border-left-color: #ff0000; color: #ff6666; }
        .success { border-left-color: #00ff00; color: #66ff66; }
        .warning { border-left-color: #ffff00; color: #ffff66; }
        button {
            background: #333;
            color: #00ff00;
            border: 1px solid #00ff00;
            padding: 10px 20px;
            margin: 10px 5px;
            cursor: pointer;
            font-family: monospace;
        }
        button:hover { background: #00ff00; color: #000; }
        .data-block {
            background: #1a1a1a;
            border: 1px solid #444;
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
            white-space: pre-wrap;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        input {
            background: #333;
            color: #00ff00;
            border: 1px solid #00ff00;
            padding: 8px;
            margin: 5px;
            font-family: monospace;
            width: 300px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Debug User Role Assignment</h1>
        
        <div>
            <h3>Step 1: Login and Check Current Role</h3>
            <input type="email" id="loginEmail" placeholder="admin@codewars.com" value="admin@codewars.com">
            <input type="password" id="loginPassword" placeholder="admin123!" value="admin123!">
            <button onclick="loginAndCheckRole()">Login & Check Role</button>
            <div id="loginResult"></div>
        </div>

        <div>
            <h3>Step 2: Check All Users and Roles</h3>
            <button onclick="checkAllUsersAndRoles()">Check All Users & Roles</button>
            <div id="usersResult"></div>
        </div>

        <div>
            <h3>Step 3: Create Admin User</h3>
            <input type="email" id="newAdminEmail" placeholder="admin@codewars.com" value="admin@codewars.com">
            <button onclick="createAdminUser()">Create Admin User</button>
            <div id="createAdminResult"></div>
        </div>

        <div>
            <h3>Step 4: Assign Admin Role</h3>
            <input type="email" id="assignEmail" placeholder="admin@codewars.com" value="admin@codewars.com">
            <button onclick="assignAdminRole()">Assign Admin Role</button>
            <div id="assignResult"></div>
        </div>

        <div>
            <h3>Step 5: Generate SQL Fix</h3>
            <button onclick="generateUserRoleSQL()">Generate User Role SQL</button>
            <div id="sqlResult"></div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = "https://wscdzjtwaxunorfmpuzl.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndzY2R6anR3YXh1bm9yZm1wdXpsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk2NTU1NDQsImV4cCI6MjA4NTIzMTU0NH0.0zDOMWXle1bwyM5LJpgh3PdEQq1n7E-mmL8adMZiWlc";

        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        function log(message, type = 'info', containerId = 'results') {
            const container = document.getElementById(containerId);
            if (container) {
                const div = document.createElement('div');
                div.className = `test-result ${type}`;
                div.innerHTML = `<strong>[${new Date().toLocaleTimeString()}]</strong> ${message}`;
                container.appendChild(div);
                container.scrollTop = container.scrollHeight;
            }
        }

        async function loginAndCheckRole() {
            const container = document.getElementById('loginResult');
            container.innerHTML = '';
            
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            log(`üîç Logging in as ${email}...`, 'info', 'loginResult');
            
            try {
                // Sign in
                const { data: authData, error: authError } = await supabase.auth.signInWithPassword({
                    email: email,
                    password: password
                });
                
                if (authError) {
                    log(`‚ùå Login failed: ${authError.message}`, 'error', 'loginResult');
                    return;
                }
                
                log('‚úÖ Login successful!', 'success', 'loginResult');
                log(`User ID: ${authData.user.id}`, 'info', 'loginResult');
                log(`Email: ${authData.user.email}`, 'info', 'loginResult');
                
                // Check user role
                const { data: roleData, error: roleError } = await supabase
                    .from('user_roles')
                    .select('*')
                    .eq('user_id', authData.user.id);
                
                if (roleError) {
                    log(`‚ùå Error checking role: ${roleError.message}`, 'error', 'loginResult');
                } else if (roleData && roleData.length > 0) {
                    log(`‚úÖ User role found: ${roleData[0].role}`, 'success', 'loginResult');
                    log(`<div class="data-block">${JSON.stringify(roleData, null, 2)}</div>`, 'info', 'loginResult');
                } else {
                    log(`‚ùå No role assigned to this user`, 'error', 'loginResult');
                    log(`üí° This user needs an admin role to access admin dashboard`, 'warning', 'loginResult');
                }
                
                // Sign out
                await supabase.auth.signOut();
                log('üîì Signed out', 'info', 'loginResult');
                
            } catch (error) {
                log(`‚ùå Login check failed: ${error.message}`, 'error', 'loginResult');
            }
        }

        async function checkAllUsersAndRoles() {
            const container = document.getElementById('usersResult');
            container.innerHTML = '';
            
            log('üîç Checking all users and their roles...', 'info', 'usersResult');
            
            try {
                // Get all user roles
                const { data: roleData, error: roleError } = await supabase
                    .from('user_roles')
                    .select('*');
                
                if (roleError) {
                    log(`‚ùå Error fetching roles: ${roleError.message}`, 'error', 'usersResult');
                } else {
                    log(`‚úÖ Found ${roleData.length} user role assignments:`, 'success', 'usersResult');
                    log(`<div class="data-block">${JSON.stringify(roleData, null, 2)}</div>`, 'info', 'usersResult');
                }
                
                // Get all teams
                const { data: teamData, error: teamError } = await supabase
                    .from('teams')
                    .select('*');
                
                if (teamError) {
                    log(`‚ùå Error fetching teams: ${teamError.message}`, 'error', 'usersResult');
                } else {
                    log(`‚úÖ Found ${teamData.length} teams:`, 'success', 'usersResult');
                    teamData.forEach(team => {
                        log(`Team: ${team.team_name} (${team.leader_email})`, 'info', 'usersResult');
                    });
                }
                
            } catch (error) {
                log(`‚ùå Check failed: ${error.message}`, 'error', 'usersResult');
            }
        }

        async function createAdminUser() {
            const container = document.getElementById('createAdminResult');
            container.innerHTML = '';
            
            const email = document.getElementById('newAdminEmail').value;
            
            log(`üîß Creating admin user: ${email}`, 'info', 'createAdminResult');
            log(`‚ö†Ô∏è This requires manual creation in Supabase Dashboard`, 'warning', 'createAdminResult');
            
            container.innerHTML += `
                <div class="test-result warning">
                    <strong>üìù Manual Steps Required:</strong>
                    <p>1. Go to <a href="https://supabase.com/dashboard" target="_blank" style="color: #66ff66;">Supabase Dashboard</a></p>
                    <p>2. Select project: wscdzjtwaxunorfmpuzl</p>
                    <p>3. Go to Authentication ‚Üí Users</p>
                    <p>4. Click "Add user"</p>
                    <p>5. Email: ${email}</p>
                    <p>6. Password: admin123!</p>
                    <p>7. ‚úÖ Check "Auto Confirm User"</p>
                    <p>8. Click "Create user"</p>
                    <p>9. Then use "Assign Admin Role" button below</p>
                </div>
            `;
        }

        async function assignAdminRole() {
            const container = document.getElementById('assignResult');
            container.innerHTML = '';
            
            const email = document.getElementById('assignEmail').value;
            
            log(`üîß Assigning admin role to: ${email}`, 'info', 'assignResult');
            
            try {
                // First, try to find the user by email (this won't work with current permissions)
                log(`üí° Note: This requires the user to exist in auth.users first`, 'warning', 'assignResult');
                
                // Generate SQL instead
                const sql = `-- Assign admin role to user
INSERT INTO public.user_roles (user_id, role)
SELECT id, 'admin'::app_role
FROM auth.users 
WHERE email = '${email}'
ON CONFLICT (user_id, role) DO NOTHING;

-- Verify the role was assigned
SELECT 
    u.email,
    ur.role,
    ur.id as role_id
FROM auth.users u
JOIN public.user_roles ur ON u.id = ur.user_id
WHERE u.email = '${email}';`;

                log(`üìù Run this SQL in Supabase SQL Editor:`, 'info', 'assignResult');
                log(`<div class="data-block">${sql}</div>`, 'info', 'assignResult');
                
            } catch (error) {
                log(`‚ùå Role assignment failed: ${error.message}`, 'error', 'assignResult');
            }
        }

        function generateUserRoleSQL() {
            const container = document.getElementById('sqlResult');
            
            const sql = `-- Complete User Role Setup for CodeWars 2.0
-- Run this in Supabase SQL Editor

-- 1. Create admin user role (assumes user exists in auth.users)
INSERT INTO public.user_roles (user_id, role)
SELECT id, 'admin'::app_role
FROM auth.users 
WHERE email = 'admin@codewars.com'
ON CONFLICT (user_id, role) DO NOTHING;

-- 2. Create test user role (assumes user exists in auth.users)
INSERT INTO public.user_roles (user_id, role)
SELECT id, 'user'::app_role
FROM auth.users 
WHERE email = 'testwarriors@codewars.com'
ON CONFLICT (user_id, role) DO NOTHING;

-- 3. Verify all user roles
SELECT 
    u.email,
    ur.role,
    u.created_at as user_created,
    ur.id as role_id
FROM auth.users u
LEFT JOIN public.user_roles ur ON u.id = ur.user_id
ORDER BY u.created_at;

-- 4. Check if admin user exists
SELECT 
    'Admin user exists: ' || CASE WHEN COUNT(*) > 0 THEN 'YES' ELSE 'NO' END as admin_status
FROM auth.users 
WHERE email = 'admin@codewars.com';

-- 5. Check if admin role is assigned
SELECT 
    'Admin role assigned: ' || CASE WHEN COUNT(*) > 0 THEN 'YES' ELSE 'NO' END as admin_role_status
FROM auth.users u
JOIN public.user_roles ur ON u.id = ur.user_id
WHERE u.email = 'admin@codewars.com' AND ur.role = 'admin';`;

            container.innerHTML = `
                <div class="test-result success">
                    <strong>üìù Complete User Role Setup SQL</strong>
                    <div class="data-block">${sql}</div>
                </div>
                <div class="test-result warning">
                    <strong>‚ö†Ô∏è Prerequisites:</strong>
                    <p>1. User must exist in Supabase Authentication first</p>
                    <p>2. Create users manually in Supabase Dashboard ‚Üí Authentication ‚Üí Users</p>
                    <p>3. Then run this SQL to assign roles</p>
                </div>
            `;
        }

        // Auto-run on load
        window.addEventListener('load', () => {
            log('üîß User Role Debugger loaded. Use the buttons above to diagnose role issues.', 'info', 'loginResult');
        });
    </script>
</body>
</html>